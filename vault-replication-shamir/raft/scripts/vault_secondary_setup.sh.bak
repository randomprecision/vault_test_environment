#!/bin/bash

# This script installs & sets up basic configuration for Vault+prem with Consul client 
echo "Installing AWS dependencies ..."
sudo apt-get update
sudo apt-get install -y awscli unzip curl jq net-tools vim libcap2-bin apt-file tmux

# Install Consul 
echo "Fetching Consul version ${CONSUL_VERSION} ..."
cd /tmp/
curl -s https://releases.hashicorp.com/consul/${CONSUL_VERSION}/consul_${CONSUL_VERSION}_linux_amd64.zip -o consul.zip
echo "Installing Consul version ${CONSUL_VERSION} ..."
unzip consul.zip
sudo chmod +x consul
sudo mv consul /usr/bin/consul
sudo mkdir /etc/consul.d
sudo chmod a+w /etc/consul.d


# Install Vault+prem
echo "Installing Vault ${VAULT_VERSION}+prem . . ."

# Figure out if version is in new S3 paths or old ones
#function version { echo "$@" | awk -F. '{ printf("%d%03d%03d%03d\n", $1,$2,$3,$4); }'; }

#if [ $(version $VAULT_VERSION) -ge $(version "0.9.0") ]; then
#	aws s3 csleep 10p s3://hc-enterprise-binaries/vault/prem/${VAULT_VERSION}/vault-enterprise_${VAULT_VERSION}+prem_linux_amd64.zip .
	
#	sudo unzip -d /usr/local/bin vault-enterprise_${VAULT_VERSION}+prem_linux_amd64.zip 
# For 0.8.3 and less:
#else
#	aws s3 cp s3://hc-enterprise-binaries/vault-enterprise/${VAULT_VERSION}/vault-enterprise_${VAULT_VERSION}_linux_amd64.zip .
#	sleep 10
#	sudo unzip -d /usr/local/bin vault-enterprise_${VAULT_VERSION}_linux_amd64.zip
#fi 

# Install Vault+ent from releases.hashicorp.com instead of AWS
echo "Fetching Vault version ${VAULT_VERSION}+ent ..."
curl -sO https://releases.hashicorp.com/vault/${VAULT_VERSION}+ent/vault_${VAULT_VERSION}+ent_linux_amd64.zip
echo "Installing Vault version ${VAULT_VERSION}+ent ..."
sleep 20
sudo unzip -d /usr/local/bin/ vault_${VAULT_VERSION}+ent_linux_amd64.zip

# Check version
vault --version

# Write Vault configuration file 
echo "Writing Vault configuration file"

sudo mkdir /etc/vault 
#make the license happen 
sudo echo "02MV4UU43BK5HGYYTOJZWFQMTMNNEWU33JJ5KFE2SNKRRXUTKHKV2FURCNGVHUGMBTJYZE43CMKRKTKTL2MN2FS3KRGNHEORJRJVWVKMK2K5ETASLJO5UVSM2WPJSEOOLULJMEUZTBK5IWST3JJF5E23KWNNGUIVJSJV4TAMSONVITCTCXIUZFSVCBORMXURJUJZUTA6SOIRFGUT2EJV5FS3KNGBHEORLJJRBUU4DCNZHDAWKXPBZVSWCSOBRDENLGMFLVC2KPNFEXCSLJO5UWCWCOPJSFOVTGMRDWY5C2KNETMSLKJF3U22SFORGUIY3UJVVGYVKNKRKTMTKUJE3E2RDLOVGUISJQJVVFCMCPKRUGCSLJO5UWGM2SNBRW4UTGMRDWY5C2KNETMSLKJF3U22SFORGUIY3UJVVGYVKNIRATMTKEIE3E2RCCMFEWS53JLJMGQ53BLBFGQZCHNR3GE3BZGBQVOMLMJFVG62KNNJAXSTLZGB3U46JQPFHVMULXJVCG652NIRXXOTKGN5UUYQ2KGBNFQSTUMFLTK2DEI5WHMYTMHEYGCVZRNREWU33JJVVEC6KNPEYHOTTZGB4U6VSRO5GUI33XJVCG652NIZXWSTCDJJ3WG3JZNNSFOTRQJFVG62LENVDDCYSIKFUUYQ2KNVREORTOMN4USNTFPFFHIYRSKIYWER2WPJEWU4DCJFWTCMLCJBJHATCXKJVEYWCONJMVO6DMJFUXO2K2GI4TEWSYJJ2VSVZVNJNFGMLXMIZHQ4CZGNVWSTCDJJUFUSC2NBRG2TTMLJBTC22ZLBJGQTCYIJ4WEM2SNRMTGUTQMIZDI2KYLAYTSLRVINAUWL2OJZGGQ6DXNBRTA6TSOFDEWNCEKQYSWMTTIMZEOQTWKZZWGZRZIJBC6T2EJ5SXEVSXPEYDKVKGJ5KC6NCWJYVU6NSMJBGUYRBQKZXXS43VF5BUCMTMNNCHUTDKHB4TGQRVGFSEC23DME2GIVRQGMZTQUDXNVLGYYLWJJIDI4CKPBEUSOKEGZKUMTCVMFLFA2TLK5FHIY2EGZYGC3BWN5HWMR3OJMZHUUCLJJJG2R2IKYZWKWTXOFDGKK3PG5VS64ZLIFKE42CQLJTVGL2LKZMWOL2LFNWEOUDXJQ3WUQTYJE3UOT3BNM3FKYLJMFEG6ZLLGBJFI3ZXGJCFCPJ5" > /etc/vault/vault.hclic
cat <<- EOF > /etc/vault/vault.hcl
license_path = "/etc/vault/vault.hclic"
disable_mlock = true
ui = true
listener "tcp" {
  address = "0.0.0.0:8200"
  tls_disable = "true"
}
storage "consul" {
  address = "0.0.0.0:8500"
  path = "vault"
}
log_level = "TRACE"
EOF

# Write Consul Configuration
echo "Writing Consul client configuration"
cat <<- EOF > /etc/consul.d/client.json
{
	"data_dir": "/tmp/consul",
	"log_level": "INFO",
	"server": false,
	"bind_addr": "0.0.0.0"
}
EOF

# Run

if [ ${CONSUL_NODE} = "primary_consul_client" ]; then
	echo "Starting Consul client agent for ${CONSUL_NODE}..."
	consul agent -node=primary-client -advertise=172.20.20.10 -retry-join=172.20.20.12 -config-dir=/etc/consul.d &> /var/log/consul.log &
	sleep 10
elif [ ${CONSUL_NODE} = "secondary_consul_client" ]; then
	echo "Starting Consul client agent for ${CONSUL_NODE}..."
	consul agent -node=secondary-client -advertise=172.20.20.11 -retry-join=172.20.20.13 -config-dir=/etc/consul.d &> /var/log/consul.log &
	sleep 10
fi


# Start Vault server on Vault nodes
export VAULT_ADDR="http://127.0.0.1"
echo "Starting Vault server ..."
vault server -log-level=debug -config=/etc/vault/vault.hcl &> /var/log/vault.log &
